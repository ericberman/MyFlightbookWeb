using Newtonsoft.Json;
using System;
using System.Globalization;
using System.Collections.Generic;
using System.Text;

/******************************************************
 * 
 * Copyright (c) 2022 MyFlightbook LLC
 * Contact myflightbook-at-gmail.com for more information
 *
*******************************************************/

// Implements import from Leon flight scheduling
// See https://bitbucket.org/leondevteam/api-documentation/src/99457e945a56eae44bbcc70a0211399fb306e4a5/authentication/OAuthCodeGrant.md,
// and http://api-schema-doc.s3-website-eu-west-1.amazonaws.com/reservationstatus.doc.html
// Schema described at http://api-schema-doc.s3-website-eu-west-1.amazonaws.com/
namespace MyFlightbook.ImportFlights.Leon
{
    #region Flight object from Leon
    // Generated by Xamasoft JSON Class Generator
    // http://www.xamasoft.com/json-class-generator
    [Serializable]
    public class LeonAirportCode
    {

        [JsonProperty("mostDescriptive")]
        public string MostDescriptive { get; set; } = string.Empty;
    }

    [Serializable]
    public class LeonPerson
    {

        [JsonProperty("surname")]
        public string Surname { get; set; } = string.Empty;

        [JsonProperty("code")]
        public string Code { get; set; } = string.Empty;
    }

    [Serializable]
    public class LeonLoggedUser
    {

        [JsonProperty("logbook")]
        public LeonFlightEntry[] Logbook { get; set; } = Array.Empty<LeonFlightEntry>();

        [JsonProperty("blockHours")]
        public string BlockHours { get; set; }
    }

    [Serializable]
    public class LeonFlightData
    {

        [JsonProperty("loggedUser")]
        public LeonLoggedUser LoggedUser { get; set; }
    }

    [Serializable]
    public class LeonFlightRoot
    {

        [JsonProperty("data")]
        public LeonFlightData Data { get; set; }
    }

    [Serializable]
    public class LeonFlightEntry : ExternalFormat
    {
        public string Username { get; set; } = string.Empty;

        #region Generated JSON properties
        [JsonProperty("flightDate")]
        public DateTime FlightDate { get; set; } = DateTime.Now.Date;

        [JsonProperty("flightNumber")]
        public string FlightNumber { get; set; } = string.Empty;

        [JsonProperty("dutyStartTime")]
        public DateTime DutyStartTime { get; set; } = DateTime.MinValue;

        [JsonProperty("dutyEndTime")]
        public DateTime DutyEndTime { get; set; } = DateTime.MinValue;

        [JsonProperty("actualDepartureTime")]
        public DateTime ActualDepartureTime { get; set; } = DateTime.MinValue;

        [JsonProperty("actualArrivalTime")]
        public DateTime ActualArrivalTime { get; set; } = DateTime.MinValue;

        [JsonProperty("takeoffTime")]
        public DateTime TakeoffTime { get; set; } = DateTime.MinValue;

        [JsonProperty("landingTime")]
        public DateTime LandingTime { get; set; } = DateTime.MinValue;

        [JsonProperty("departureAirportCode")]
        public LeonAirportCode DepartureAirportCode { get; set; }

        [JsonProperty("destinationAirportCode")]
        public LeonAirportCode DestinationAirportCode { get; set; }

        [JsonProperty("aircraftRegistration")]
        public string AircraftRegistration { get; set; } = string.Empty;

        [JsonProperty("aircraftType")]
        public string AircraftType { get; set; } = string.Empty;

        [JsonProperty("commander")]
        public string Commander { get; set; } = string.Empty;

        [JsonProperty("pic")]
        public LeonPerson Pic { get; set; }

        [JsonProperty("sic")]
        public LeonPerson Sic { get; set; }

        [JsonProperty("totalFlightTime")]
        public string totalFlightTime { get; set; } = string.Empty;

        [JsonProperty("durationOfFlightTime")]
        public string DurationOfFlightTime { get; set; } = string.Empty;

        [JsonProperty("ifrTime")]
        public string IfrTime { get; set; } = string.Empty;

        [JsonProperty("nightFlightTime")]
        public string NightFlightTime { get; set; } = string.Empty;

        [JsonProperty("multiPilotFlightTime")]
        public string MultiPilotFlightTime { get; set; } = string.Empty;

        [JsonProperty("picTime")]
        public string PicTime { get; set; } = string.Empty;

        [JsonProperty("picNightTime")]
        public string PicNightTime { get; set; } = string.Empty;

        [JsonProperty("sicTime")]
        public string SicTime { get; set; } = string.Empty;

        [JsonProperty("sicNightTime")]
        public string SicNightTime { get; set; } = string.Empty;

        [JsonProperty("soloFlightTime")]
        public string SoloFlightTime { get; set; } = string.Empty;

        [JsonProperty("dualPilotTimeReceived")]
        public string DualPilotTimeReceived { get; set; } = string.Empty;

        [JsonProperty("dualPilotTimeGiven")]
        public string DualPilotTimeGiven { get; set; } = string.Empty;

        [JsonProperty("dayTakeoffCount")]
        public int DayTakeoffCount { get; set; }

        [JsonProperty("nightTakeoffCount")]
        public int NightTakeoffCount { get; set; }

        [JsonProperty("dayLandingCount")]
        public int DayLandingCount { get; set; }

        [JsonProperty("nightLandingCount")]
        public int NightLandingCount { get; set; }

        [JsonProperty("approachList")]
        public string[] ApproachList { get; set; } = Array.Empty<string>();

        [JsonProperty("approachTypeList")]
        public string[] ApproachTypeList { get; set; } = Array.Empty<string>();
        #endregion

        public override LogbookEntry ToLogbookEntry()
        {
            // Always return pending flights
            PendingFlight pf = new PendingFlight()
            {
                Date = FlightDate, 
                Route = JoinStrings(new string[] { DepartureAirportCode.MostDescriptive, DestinationAirportCode.MostDescriptive }),
                FlightStart = TakeoffTime,
                FlightEnd = LandingTime,
                TailNumDisplay = AircraftRegistration ?? String.Empty,
                ModelDisplay = AircraftType ?? String.Empty,
                TotalFlightTime = totalFlightTime == null ? 0 : totalFlightTime.SafeParseDecimal(),
                IMC =  IfrTime == null ? 0 : IfrTime.SafeParseDecimal(),
                Nighttime = NightFlightTime == null ? 0 : NightFlightTime.SafeParseDecimal(),
                PIC =  PicTime == null ? 0 : PicTime.SafeParseDecimal(),
                SIC = SicTime == null ? 0 : SicTime.SafeParseDecimal(),
                Dual =  DualPilotTimeReceived == null ? 0 : DualPilotTimeReceived.SafeParseDecimal(),
                CFI =  DualPilotTimeGiven == null ? 0 : DualPilotTimeGiven.SafeParseDecimal(),
                FullStopLandings = DayLandingCount,
                NightLandings = NightLandingCount,
                Approaches = ApproachList.Length,
                User = Username
            };

            List<CustomFlightProperty> lst = new List<CustomFlightProperty>()
            {
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropFlightNumber, FlightNumber),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropDutyStart, DutyStartTime, true),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropDutyEnd, DutyEndTime, true),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDBlockOut, ActualDepartureTime, true),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDBlockIn, ActualArrivalTime, true),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropNameOfPIC, Pic == null || String.IsNullOrEmpty(Pic.Surname) ? Commander : Pic.Surname),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropNameOfSIC, Sic == null || Sic.Surname == null ? string.Empty : Sic.Surname),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropMultiPilotTime, MultiPilotFlightTime.DecimalFromHHMM()),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropSolo, SoloFlightTime == null ? 0 : SoloFlightTime.DecimalFromHHMM()),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropNightTakeoff, NightTakeoffCount),
                CustomFlightProperty.PropertyWithValue(CustomPropertyType.KnownProperties.IDPropApproachName, JoinStrings(ApproachTypeList))
            };
            
            pf.CustomProperties.SetItems(lst);
            
            return pf;
        }

        public static IEnumerable<LeonFlightEntry> FromLeonRootJSON(String szJSON)
        {
            if (szJSON == null)
                throw new ArgumentNullException(nameof(szJSON));

            LeonFlightRoot root = JsonConvert.DeserializeObject<LeonFlightRoot>(szJSON);
            return root.Data.LoggedUser.Logbook;
        }
    }
    #endregion

    [Serializable]
    public class LeonTimeInterval
    {
        public DateTime? start { get; set; }
        public DateTime? end { get; set; }

        public override string ToString()
        {
            StringBuilder sb = new StringBuilder();
            if (start.HasValue)
                sb.AppendFormat(CultureInfo.InvariantCulture, "start: \"{0}\" ", start.Value.YMDString());
            if (end.HasValue)
                sb.AppendFormat(CultureInfo.InvariantCulture, "end: \"{0}\" ", end.Value.YMDString());
            return sb.ToString();
        }
    }

    public class LeonQuery
    {
        #region properties
        protected LeonTimeInterval timeInterval;
        #endregion

        public LeonQuery(DateTime? dtStart, DateTime? dtEnd)
        {
            timeInterval = new LeonTimeInterval() { start = dtStart, end = dtEnd };
        }

        public override string ToString()
        {
            // this is a hack, but should do the trick
            return String.Format(CultureInfo.InvariantCulture, @"{{
  loggedUser {{
    logbook(timeInterval: {{ {0} }}, stripAircraftRegistrationSeparator: false) {{
      flightDate
      flightNumber
      dutyStartTime
      dutyEndTime
      actualDepartureTime
      actualArrivalTime
      takeoffTime
      landingTime
      departureAirportCode {{mostDescriptive}}
      destinationAirportCode {{mostDescriptive}}
      aircraftRegistration
      aircraftType
      commander
      pic {{surname}}
      sic {{surname}}
      totalFlightTime
      durationOfFlightTime
      ifrTime
      nightFlightTime
      multiPilotFlightTime
      picTime
      picNightTime
      sicTime
      sicNightTime
      soloFlightTime
      dualPilotTimeReceived
      dualPilotTimeGiven
      dayTakeoffCount
      nightTakeoffCount
      dayLandingCount
      nightLandingCount
      approachList {{ 
        approach
        count }}
      approachTypeList {{
        approachType
        count }}
    }}
    blockHours(timeInterval: {{ {0} }}, timeZoneToggle: {{ baseNid: 1, timeZone: UTC }})
  }}
}}", timeInterval.ToString());
        }
    }

    public class LeonOAuth
    {
        public const string TokenSessionKey = "LeonTokenSessionKey";
    }
}
